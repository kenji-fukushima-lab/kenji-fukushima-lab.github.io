import{highlightSearchTerm}from"./highlight-search-term.js";const normalize=e=>(e??"").toString().trim().toLowerCase(),normalizeDoi=e=>normalize(e).replace(/^https?:\/\/(dx\.)?doi\.org\//,"").replace(/^doi:\s*/,""),CONTACT_EMAIL="kenji.fukushima@nig.ac.jp",CROSSREF_WORKS_ENDPOINT="https://api.crossref.org/works",parseNumber=e=>{const t=(e??"").toString().replace(/,/g,"").match(/-?\d+(\.\d+)?/);if(!t)return 0;const r=Number.parseFloat(t[0]);return Number.isFinite(r)?r:0},uniqueSorted=e=>[...new Set(e.filter(Boolean))].sort((e,t)=>e.localeCompare(t)),splitDelimited=e=>normalize(e).split("||").map(e=>e.trim()).filter(Boolean),nameForDisplay=e=>{const t=normalize(e);if(!t)return"";const[r,n]=t.split(",").map(e=>e.trim());return n&&r?`${n} ${r}`:t.replace(/\b\w/g,e=>e.toUpperCase())},createElement=(e,t="")=>{const r=document.createElement(e);return t&&(r.className=t),r},isJapanesePage=document.documentElement.lang.toLowerCase().startsWith("ja"),LAB_MEMBER_FACET_VALUE="__lab_member__",OTHER_FACET_VALUE="__other__",ARTICLE_TYPE_ORIGINAL="__article_type_original__",ARTICLE_TYPE_PREPRINT="__article_type_preprint__",ARTICLE_TYPE_REVIEW_OTHERS="__article_type_review_others__",articleTypeFacetValue=e=>{const t=normalize(e);return"original"===t?ARTICLE_TYPE_ORIGINAL:"preprint"===t?ARTICLE_TYPE_PREPRINT:ARTICLE_TYPE_REVIEW_OTHERS},i18n={all:isJapanesePage?"\u3059\u3079\u3066":"All",showing:isJapanesePage?"\u8868\u793a\u4e2d":"Showing",sortedResults:isJapanesePage?"\u4e26\u3073\u66ff\u3048\u7d50\u679c":"Sorted results",newest:isJapanesePage?"\u65b0\u7740\u9806":"Newest",noResults:isJapanesePage?"\u8a72\u5f53\u3059\u308b\u8ad6\u6587\u304c\u3042\u308a\u307e\u305b\u3093\u3002":"No matching publications.",badgeIdle:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u306f\u672a\u8aad\u8fbc\u3067\u3059\u3002":"External badges are not loaded yet.",badgeLoading:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u3092\u8aad\u307f\u8fbc\u307f\u4e2d...":"Loading external badges...",badgeLoaded:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u3092\u8aad\u307f\u8fbc\u307f\u307e\u3057\u305f\u3002":"External badges loaded.",badgeError:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u306e\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002":"Failed to load external badges.",citationHydrating:isJapanesePage?"\u88ab\u5f15\u7528\u6570\u3092\u66f4\u65b0\u4e2d...":"Refreshing citation counts...",citationHydrated:isJapanesePage?"\u88ab\u5f15\u7528\u6570\u3092\u66f4\u65b0\u3057\u307e\u3057\u305f\u3002":"Citation counts refreshed.",leadRoleLabel:isJapanesePage?"lab member\u304cfirst/co-first/corresponding":"Lab member as first/co-first/corresponding",otherRoleLabel:isJapanesePage?"\u305d\u308c\u4ee5\u5916":"Other",paperCountAxisLabel:isJapanesePage?"\u8ad6\u6587\u6570":"Number of publications",labMemberFacetOption:"lab member",otherFacetOption:"other",crossrefSortLabel:isJapanesePage?"Crossref\u88ab\u5f15\u7528\u9806":"Crossref citations",dimensionsSortLabel:isJapanesePage?"Dimensions\u88ab\u5f15\u7528\u9806":"Dimensions citations",altmetricSortLabel:"Altmetric",labSortLabel:isJapanesePage?"Lab\u8ca2\u732e\u5ea6":"Lab contribution",altmetricHint:isJapanesePage?"Altmetric\u9806\u306f`altmetric_score`\u304c\u3042\u308b\u8ad6\u6587\u3092\u512a\u5148\u3057\u3066\u4e26\u3073\u66ff\u3048\u307e\u3059\u3002":"Altmetric sort prioritizes publications with `altmetric_score` metadata."},trackAnalyticsEvent=(e,t={})=>{if(!e)return;const r={page_path:window.location.pathname,...t};"function"!=typeof window.trackSiteEvent?"function"!=typeof window.gtag?(window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:e,...r})):window.gtag("event",e,r):window.trackSiteEvent(e,r)},defaultFacetConfig=[{id:"facet-year",key:"year",labeler:e=>e.toString()},{id:"facet-article-type",key:"articleType",labeler:e=>e,fixedOptions:[{value:ARTICLE_TYPE_ORIGINAL,label:"Original"},{value:ARTICLE_TYPE_PREPRINT,label:"Preprint"},{value:ARTICLE_TYPE_REVIEW_OTHERS,label:"Review & others"}]},{id:"facet-first-author",key:"firstAuthor",labeler:nameForDisplay,fixedOptions:[{value:LAB_MEMBER_FACET_VALUE,label:i18n.labMemberFacetOption},{value:OTHER_FACET_VALUE,label:i18n.otherFacetOption}]},{id:"facet-corresponding",key:"corresponding",labeler:nameForDisplay,isList:!0,fixedOptions:[{value:LAB_MEMBER_FACET_VALUE,label:i18n.labMemberFacetOption},{value:OTHER_FACET_VALUE,label:i18n.otherFacetOption}]}];document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".publications"),t=document.getElementById("bibsearch");if(!e||!t)return;const r=document.getElementById("pub-sort"),n=document.getElementById("pub-reset-filters"),o=document.getElementById("pub-load-badges"),a=document.getElementById("pub-active-count"),i=document.getElementById("pub-badge-status"),l=Array.from(e.querySelectorAll("ol.bibliography > li"));if(!l.length)return;const s=l.map((e,t)=>{const r=e.querySelector(".publication-entry");if(!r)return null;const n=Number.parseInt(r.dataset.year??"0",10)||0,o=Number.parseInt(r.dataset.month??"0",10)||0,a=normalize(r.dataset.firstAuthor),i=splitDelimited(r.dataset.corresponding),l=splitDelimited(r.dataset.coFirst),s=splitDelimited(r.dataset.labMembers),c=articleTypeFacetValue(r.dataset.articleType),d=parseNumber(r.dataset.crossrefCount??r.dataset.citationCount),u=parseNumber(r.dataset.dimensionsCount),m=parseNumber(r.dataset.altmetricScore),p=normalizeDoi(r.dataset.doi),b=new Set(s);let g=s.length;a&&b.has(a)&&(g+=2),g+=l.filter(e=>b.has(e)).length,g+=i.filter(e=>b.has(e)).length;const h=a&&b.has(a)||l.some(e=>b.has(e))||i.some(e=>b.has(e));return{index:t,listItem:e,publicationEntry:r,title:normalize(e.querySelector(".publication-title .title")?.textContent),searchText:normalize(e.textContent),year:n,month:o,articleType:c,firstAuthor:a,corresponding:i,coFirst:l,labMembers:s,citationCount:d,dimensionsCitationCount:u,altmetricScore:m,contributionScore:g,leadRole:h,doi:p}}).filter(Boolean),c=s.some(e=>Boolean(e.listItem.querySelector(".altmetric-embed"))),d=s.map(e=>e.year).filter(e=>Number.isInteger(e)&&e>0),u=d.length?Math.min(...d):(new Date).getFullYear(),m=d.length?Math.max(...d):u,p=Array.from({length:m-u+1},(e,t)=>(u+t).toString()),b=createElement("div","publications-results");b.id="publications-results",e.querySelectorAll("h2.bibliography, ol.bibliography").forEach(e=>e.remove()),e.appendChild(b);let g=r?.value||"newest";"citations"===g&&(g="crossref-citations",r&&(r.value="crossref-citations"));let h="idle",f=null,y=null,E=0,C=!1,_=!1,A=null,v=null,L=null,S="",w=0,T={byYear:null};c||(o&&(o.style.display="none"),i&&(i.style.display="none"));const I=(e,t="")=>{h=e,i&&(i.textContent=t||("loading"===e?i18n.badgeLoading:"loaded"===e?i18n.badgeLoaded:"error"===e?i18n.badgeError:i18n.badgeIdle))},R=(e,t,r,n=[])=>{const o=document.getElementById(e);if(!o)return;const a=o.value;o.innerHTML="";const i=document.createElement("option");i.value="",i.textContent=i18n.all,o.appendChild(i),n.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,o.appendChild(t)}),t.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=r(e),o.appendChild(t)}),a&&Array.from(o.options).some(e=>e.value===a)&&(o.value=a)},x=()=>{defaultFacetConfig.forEach(e=>{if(e.fixedOptions)return void R(e.id,[],e.labeler,e.fixedOptions);const t=e.isList?uniqueSorted(s.flatMap(t=>t[e.key])):uniqueSorted(s.map(t=>"year"===e.key?t.year.toString():t[e.key])),r="year"===e.key?t.sort((e,t)=>Number.parseInt(t,10)-Number.parseInt(e,10)):t;R(e.id,r,e.labeler,[])})},P=()=>{const e={};return defaultFacetConfig.forEach(t=>{const r=document.getElementById(t.id);e[t.key]=normalize(r?.value)}),e},k=(e,t,r)=>{if(t&&!e.searchText.includes(t))return!1;if(r.year&&e.year.toString()!==r.year)return!1;if(r.articleType&&e.articleType!==r.articleType)return!1;if(r.firstAuthor)if(r.firstAuthor===LAB_MEMBER_FACET_VALUE){if(!e.firstAuthor||!e.labMembers.includes(e.firstAuthor))return!1}else if(r.firstAuthor===OTHER_FACET_VALUE){if(!e.firstAuthor||e.labMembers.includes(e.firstAuthor))return!1}else if(e.firstAuthor!==r.firstAuthor)return!1;if(r.corresponding)if(r.corresponding===LAB_MEMBER_FACET_VALUE){if(!e.corresponding.some(t=>e.labMembers.includes(t)))return!1}else if(r.corresponding===OTHER_FACET_VALUE){if(!e.corresponding.length||e.corresponding.some(t=>e.labMembers.includes(t)))return!1}else if(!e.corresponding.includes(r.corresponding))return!1;return!0},F=(e,t)=>e.year!==t.year?t.year-e.year:e.month!==t.month?t.month-e.month:e.index-t.index,O=e=>"crossref-citations"===e||"citations"===e,N=e=>O(e)?i18n.crossrefSortLabel:"dimensions-citations"===e?i18n.dimensionsSortLabel:"altmetric"===e?i18n.altmetricSortLabel:"lab"===e?i18n.labSortLabel:i18n.newest,M=e=>{const t=[...e];return O(g)?(t.sort((e,t)=>t.citationCount!==e.citationCount?t.citationCount-e.citationCount:F(e,t)),t):"dimensions-citations"===g?(t.sort((e,t)=>t.dimensionsCitationCount!==e.dimensionsCitationCount?t.dimensionsCitationCount-e.dimensionsCitationCount:F(e,t)),t):"altmetric"===g?(t.sort((e,t)=>t.altmetricScore!==e.altmetricScore?t.altmetricScore-e.altmetricScore:F(e,t)),t):"lab"===g?(t.sort((e,t)=>t.contributionScore!==e.contributionScore?t.contributionScore-e.contributionScore:F(e,t)),t):(t.sort(F),t)},B=e=>{if(b.innerHTML="",!e.length){const e=createElement("p","pub-empty-state");return e.textContent=i18n.noResults,void b.appendChild(e)}if("newest"===g){const t=new Map;return e.forEach(e=>{t.has(e.year)||t.set(e.year,[]),t.get(e.year).push(e)}),void[...t.keys()].sort((e,t)=>t-e).forEach(e=>{const r=createElement("h2","bibliography");r.textContent=e.toString();const n=createElement("ol","bibliography");t.get(e).forEach(e=>n.appendChild(e.listItem)),b.append(r,n)})}const t=createElement("h2","bibliography pub-sorted-heading");t.textContent=`${i18n.sortedResults} (${N(g)})`;const r=createElement("ol","bibliography");e.forEach(e=>r.appendChild(e.listItem)),b.append(t,r)},$=e=>{a&&(a.textContent=`${i18n.showing}: ${e} / ${s.length}`)},z=e=>{if("undefined"!=typeof CSS&&"highlights"in CSS&&CSS.highlights)try{highlightSearchTerm({search:e,selector:"#publications-results li"})}catch{}},J=()=>{const e=getComputedStyle(document.documentElement);return{themeColor:e.getPropertyValue("--global-theme-color").trim()||"#2f7f75",textColor:e.getPropertyValue("--global-text-color").trim()||"#334155",dividerColor:e.getPropertyValue("--global-divider-color").trim()||"#cbd5e1",secondaryColor:e.getPropertyValue("--global-text-color-light").trim()||"#94a3b8"}},V=()=>!!window.Chart||(w+=1,w>20||setTimeout(()=>H(re),300),!1),D=(e,t,r,n,o,a={})=>{const i=document.getElementById(t);if(!i)return;const l=J();if(T[e])return T[e].data.labels=n,T[e].data.datasets=o,void T[e].update();T[e]=new window.Chart(i,{type:r,data:{labels:n,datasets:o},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,labels:{color:l.textColor}}},scales:{x:{ticks:{color:l.textColor},grid:{color:l.dividerColor}},y:{ticks:{color:l.textColor,precision:0},grid:{color:l.dividerColor}}},...a}})},H=e=>{if(!V())return;const t=new Map(p.map(e=>[e,{lead:0,other:0}]));e.forEach(e=>{const r=e.year.toString();if(!t.has(r))return;const n=t.get(r);e.leadRole?n.lead+=1:n.other+=1});const r=p,n=J(),o=r.map(e=>t.get(e).lead),a=r.map(e=>t.get(e).other),i=(e,t,o,a)=>{const i=Math.max(0,...e);return Array.from({length:i},(i,l)=>({label:t,data:r.map((t,r)=>e[r]>l?1:0),backgroundColor:o,borderColor:n.dividerColor,borderWidth:1,borderSkipped:!1,stack:"publication-counts",unitRole:a,unitLevel:l}))},l=[...i(o,i18n.leadRoleLabel,n.themeColor,"lead"),...i(a,i18n.otherRoleLabel,n.secondaryColor,"other")];D("byYear","pub-chart-year","bar",r,l,{plugins:{legend:{display:!0,labels:{color:n.textColor,filter:(e,t)=>{const r=t.datasets?.[e.datasetIndex];return 0===r?.unitLevel}}},tooltip:{callbacks:{label:e=>{const t=e.dataset;if(!t||0!==t.unitLevel)return null;const r=e.dataIndex;return"lead"===t.unitRole?`${i18n.leadRoleLabel}: ${o[r]}`:`${i18n.otherRoleLabel}: ${a[r]}`}}}},scales:{x:{stacked:!0,ticks:{color:n.textColor},grid:{color:n.dividerColor}},y:{stacked:!0,beginAtZero:!0,ticks:{color:n.textColor,precision:0,stepSize:1},title:{display:!0,text:i18n.paperCountAxisLabel,color:n.textColor},grid:{color:n.dividerColor}}}})},U=()=>A||(A=fetch("/assets/data/citation-counts.json",{cache:"no-store"}).then(e=>e.ok?e.json():null).then(e=>{const t=e?.counts;if(!t||"object"!=typeof t)return;let r=!1;s.forEach(e=>{const n=normalizeDoi(e.doi);if(!n)return;const o=parseNumber(t[n]);o>e.citationCount&&(e.citationCount=o,r=!0)}),r&&O(g)&&ne()}).catch(()=>{}),A),q=(e,t)=>new Promise((r,n)=>{const o=document.getElementById(e);if(o)return void r(o);const a=document.createElement("script");a.id=e,a.src=t,a.async=!0,a.onload=()=>r(a),a.onerror=()=>n(new Error(`Failed to load ${t}`)),document.head.appendChild(a)}),Y=()=>{"function"==typeof window._altmetric_embed_init&&window._altmetric_embed_init()},j=e=>{if(!e)return 0;const t=[e.getAttribute("data-score"),e.getAttribute("data-altmetric-score"),e.getAttribute("aria-label"),e.getAttribute("title"),e.dataset?.score,e.textContent,...Array.from(e.querySelectorAll("a, span, img")).map(e=>"IMG"===e.tagName?e.getAttribute("alt"):`${e.getAttribute("aria-label")||""} ${e.textContent||""}`.trim())];for(const e of t){const t=parseNumber(e);if(t>0)return t}return 0},W=e=>{if(!e||"object"!=typeof e)return!1;const t=parseNumber(e.score);if(t<=0)return!1;const r=normalizeDoi(e.doi),n=normalize(e.altmetric_id);let o=!1;return s.forEach(e=>{const a=e.listItem.querySelector(".altmetric-embed"),i=normalizeDoi(a?.dataset?.doi||a?.getAttribute("data-doi")),l=normalize(a?.dataset?.altmetricId||a?.getAttribute("data-altmetric-id"));(r&&(e.doi===r||i===r)||n&&l&&n===l)&&t>e.altmetricScore&&(e.altmetricScore=t,o=!0)}),o},G=()=>{let e=!1;return s.forEach(t=>{const r=t.listItem.querySelector(".altmetric-embed");if(!r)return;const n=j(r);n>t.altmetricScore&&(t.altmetricScore=n,e=!0)}),e},K=()=>{clearTimeout(y),E=0;const e=()=>{E+=1;if(G()&&"altmetric"===g&&ne(),E>=20)return;y=setTimeout(e,E<6?400:1e3)};y=setTimeout(e,250)},Z=()=>{if(C)return;const e=window._altmetric?.embed_callback;"function"==typeof e&&(window._altmetric.embed_callback=(...t)=>{const r=W(t[0]),n=e.apply(window._altmetric,t),o=G();return(r||o)&&"altmetric"===g&&ne(),n},C=!0)},Q=()=>c?f||(I("loading"),f=q("pub-altmetric-script","https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js").then(()=>{Z(),Y(),G(),K(),I("loaded"),trackAnalyticsEvent("publications_badges_loaded",{publication_count:s.length}),ne()}).catch(()=>{I("error"),trackAnalyticsEvent("publications_badges_load_error",{publication_count:s.length})}),f):(I("loaded"),f=Promise.resolve(),f),X=()=>{if(!c)return;if(!("IntersectionObserver"in window))return;const e=s.find(e=>e.listItem.querySelector(".badges"))?.listItem;if(!e)return;const t=new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&(Q(),t.disconnect())},{rootMargin:"120px 0px"});t.observe(e)},ee=async e=>{const t=await fetch(`${CROSSREF_WORKS_ENDPOINT}/${encodeURIComponent(e)}?mailto=${encodeURIComponent(CONTACT_EMAIL)}`);if(!t.ok)return null;const r=await t.json(),n=Number.parseInt(r?.message?.["is-referenced-by-count"],10);return Number.isFinite(n)?n:null},te=async()=>{if(await U(),v)return v;const e=s.filter(e=>e.doi&&e.citationCount<=0);if(!e.length)return Promise.resolve();const t=4;let r=0;return I(h,i18n.citationHydrating),v=Promise.all(Array.from({length:t}).map(async()=>{for(;r<e.length;){const t=r;r+=1;const n=e[t];try{let e=n.citationCount;const t=await ee(n.doi);Number.isFinite(t)&&t>e&&(e=t),e>n.citationCount&&(n.citationCount=e)}catch{}}})).finally(()=>{I(h,i18n.citationHydrated)}),v};let re=[...s];const ne=()=>{const e=normalize(t.value),r=P(),n=s.filter(t=>k(t,e,r)),o=M(n);B(o),$(o.length),z(e),H(o),"altmetric"===g&&a&&o.every(e=>e.altmetricScore<=0)&&(a.textContent=`${a.textContent} | ${i18n.altmetricHint}`),"loaded"===h&&Y(),re=o},oe=()=>{const e=t.value.trim(),r=e?`#${encodeURIComponent(e)}`:"";history.replaceState(null,"",`${window.location.pathname}${window.location.search}${r}`)},ae=()=>{clearTimeout(L),L=setTimeout(()=>{oe(),ne();const e=normalize(t.value);e!==S&&(S=e,trackAnalyticsEvent("publications_search",{query_length:e.length}))},250)},ie=()=>{t.value="",defaultFacetConfig.forEach(e=>{const t=document.getElementById(e.id);t&&(t.value="")}),r&&(r.value="newest",g="newest"),oe(),ne(),trackAnalyticsEvent("publications_filters_reset")},le=()=>{const e=decodeURIComponent(window.location.hash.replace(/^#/,""));e&&(t.value=e)};t.addEventListener("input",ae),window.addEventListener("hashchange",()=>{le(),ne()}),defaultFacetConfig.forEach(e=>{const t=document.getElementById(e.id);t&&t.addEventListener("change",()=>{ne(),trackAnalyticsEvent("publications_filter_change",{filter_name:e.key,filter_value:t.value||"all"})})}),r&&r.addEventListener("change",()=>{g=r.value,ne(),O(g)?(U().finally(()=>{O(g)&&ne()}),_||(_=!0,te()),v&&v.finally(()=>{O(g)&&ne()})):"altmetric"===g&&c&&"loaded"!==h?Q().finally(()=>{"altmetric"===g&&ne()}):"altmetric"===g&&c&&(G(),K(),ne()),trackAnalyticsEvent("publications_sort_change",{sort:g})}),n&&n.addEventListener("click",ie),o&&o.addEventListener("click",()=>{trackAnalyticsEvent("publications_badges_load_click"),Q()}),I("idle"),x(),le(),U(),ne(),X()});