import{highlightSearchTerm}from"./highlight-search-term.js";const normalize=e=>(e??"").toString().trim().toLowerCase(),parseNumber=e=>{const t=(e??"").toString().replace(/,/g,"").match(/-?\d+(\.\d+)?/);if(!t)return 0;const n=Number.parseFloat(t[0]);return Number.isFinite(n)?n:0},uniqueSorted=e=>[...new Set(e.filter(Boolean))].sort((e,t)=>e.localeCompare(t)),splitDelimited=e=>normalize(e).split("||").map(e=>e.trim()).filter(Boolean),nameForDisplay=e=>{const t=normalize(e);if(!t)return"";const[n,r]=t.split(",").map(e=>e.trim());return r&&n?`${r} ${n}`:t.replace(/\b\w/g,e=>e.toUpperCase())},typeForDisplay=e=>normalize(e).replace(/\s+/g," ").replace(/\b\w/g,e=>e.toUpperCase()),createElement=(e,t="")=>{const n=document.createElement(e);return t&&(n.className=t),n},isJapanesePage=document.documentElement.lang.toLowerCase().startsWith("ja"),LAB_MEMBER_FACET_VALUE="__lab_member__",OTHER_FACET_VALUE="__other__",i18n={all:isJapanesePage?"\u3059\u3079\u3066":"All",showing:isJapanesePage?"\u8868\u793a\u4e2d":"Showing",sortedResults:isJapanesePage?"\u4e26\u3073\u66ff\u3048\u7d50\u679c":"Sorted results",newest:isJapanesePage?"\u65b0\u7740\u9806":"Newest",noResults:isJapanesePage?"\u8a72\u5f53\u3059\u308b\u8ad6\u6587\u304c\u3042\u308a\u307e\u305b\u3093\u3002":"No matching publications.",badgeIdle:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u306f\u672a\u8aad\u8fbc\u3067\u3059\u3002":"External badges are not loaded yet.",badgeLoading:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u3092\u8aad\u307f\u8fbc\u307f\u4e2d...":"Loading external badges...",badgeLoaded:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u3092\u8aad\u307f\u8fbc\u307f\u307e\u3057\u305f\u3002":"External badges loaded.",badgeError:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u306e\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002":"Failed to load external badges.",citationHydrating:isJapanesePage?"\u88ab\u5f15\u7528\u6570\u3092\u66f4\u65b0\u4e2d...":"Refreshing citation counts...",citationHydrated:isJapanesePage?"\u88ab\u5f15\u7528\u6570\u3092\u66f4\u65b0\u3057\u307e\u3057\u305f\u3002":"Citation counts refreshed.",leadRoleLabel:isJapanesePage?"lab member\u304cfirst/co-first/corresponding":"Lab member as first/co-first/corresponding",otherRoleLabel:isJapanesePage?"\u305d\u308c\u4ee5\u5916":"Other",paperCountAxisLabel:isJapanesePage?"\u8ad6\u6587\u6570":"Number of publications",labMemberFacetOption:"lab member",otherFacetOption:"other",altmetricHint:isJapanesePage?"Altmetric\u9806\u306f`altmetric_score`\u304c\u3042\u308b\u8ad6\u6587\u3092\u512a\u5148\u3057\u3066\u4e26\u3073\u66ff\u3048\u307e\u3059\u3002":"Altmetric sort prioritizes publications with `altmetric_score` metadata."},trackAnalyticsEvent=(e,t={})=>{if(!e)return;const n={page_path:window.location.pathname,...t};"function"!=typeof window.trackSiteEvent?"function"!=typeof window.gtag?(window.dataLayer=window.dataLayer||[],window.dataLayer.push({event:e,...n})):window.gtag("event",e,n):window.trackSiteEvent(e,n)},defaultFacetConfig=[{id:"facet-year",key:"year",labeler:e=>e.toString()},{id:"facet-article-type",key:"articleType",labeler:typeForDisplay},{id:"facet-first-author",key:"firstAuthor",labeler:nameForDisplay,fixedOptions:[{value:LAB_MEMBER_FACET_VALUE,label:i18n.labMemberFacetOption},{value:OTHER_FACET_VALUE,label:i18n.otherFacetOption}]},{id:"facet-corresponding",key:"corresponding",labeler:nameForDisplay,isList:!0,fixedOptions:[{value:LAB_MEMBER_FACET_VALUE,label:i18n.labMemberFacetOption},{value:OTHER_FACET_VALUE,label:i18n.otherFacetOption}]}];document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".publications"),t=document.getElementById("bibsearch");if(!e||!t)return;const n=document.getElementById("pub-sort"),r=document.getElementById("pub-reset-filters"),o=document.getElementById("pub-load-badges"),a=document.getElementById("pub-active-count"),i=document.getElementById("pub-badge-status"),l=Array.from(e.querySelectorAll("ol.bibliography > li"));if(!l.length)return;const s=l.map((e,t)=>{const n=e.querySelector(".publication-entry");if(!n)return null;const r=Number.parseInt(n.dataset.year??"0",10)||0,o=Number.parseInt(n.dataset.month??"0",10)||0,a=normalize(n.dataset.firstAuthor),i=splitDelimited(n.dataset.corresponding),l=splitDelimited(n.dataset.coFirst),s=splitDelimited(n.dataset.labMembers),c=normalize(n.dataset.articleType),d=parseNumber(n.dataset.citationCount),u=parseNumber(n.dataset.altmetricScore),m=normalize(n.dataset.doi),p=new Set(s);let g=s.length;a&&p.has(a)&&(g+=2),g+=l.filter(e=>p.has(e)).length,g+=i.filter(e=>p.has(e)).length;const b=a&&p.has(a)||l.some(e=>p.has(e))||i.some(e=>p.has(e));return{index:t,listItem:e,publicationEntry:n,title:normalize(e.querySelector(".publication-title .title")?.textContent),searchText:normalize(e.textContent),year:r,month:o,articleType:c,firstAuthor:a,corresponding:i,coFirst:l,labMembers:s,citationCount:d,altmetricScore:u,contributionScore:g,leadRole:b,doi:m}}).filter(Boolean),c=s.map(e=>e.year).filter(e=>Number.isInteger(e)&&e>0),d=c.length?Math.min(...c):(new Date).getFullYear(),u=c.length?Math.max(...c):d,m=Array.from({length:u-d+1},(e,t)=>(d+t).toString()),p=createElement("div","publications-results");p.id="publications-results",e.querySelectorAll("h2.bibliography, ol.bibliography").forEach(e=>e.remove()),e.appendChild(p);let g=n?.value||"newest",b="idle",h=null,f=!1,y=null,E=null,C="",_=0,w={byYear:null};const v=(e,t="")=>{b=e,i&&(i.textContent=t||("loading"===e?i18n.badgeLoading:"loaded"===e?i18n.badgeLoaded:"error"===e?i18n.badgeError:i18n.badgeIdle))},A=(e,t,n,r=[])=>{const o=document.getElementById(e);if(!o)return;const a=o.value;o.innerHTML="";const i=document.createElement("option");i.value="",i.textContent=i18n.all,o.appendChild(i),r.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,o.appendChild(t)}),t.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=n(e),o.appendChild(t)}),a&&Array.from(o.options).some(e=>e.value===a)&&(o.value=a)},L=()=>{defaultFacetConfig.forEach(e=>{if(e.fixedOptions)return void A(e.id,[],e.labeler,e.fixedOptions);const t=e.isList?uniqueSorted(s.flatMap(t=>t[e.key])):uniqueSorted(s.map(t=>"year"===e.key?t.year.toString():t[e.key])),n="year"===e.key?t.sort((e,t)=>Number.parseInt(t,10)-Number.parseInt(e,10)):t;A(e.id,n,e.labeler,[])})},S=()=>{const e={};return defaultFacetConfig.forEach(t=>{const n=document.getElementById(t.id);e[t.key]=normalize(n?.value)}),e},x=(e,t,n)=>{if(t&&!e.searchText.includes(t))return!1;if(n.year&&e.year.toString()!==n.year)return!1;if(n.articleType&&e.articleType!==n.articleType)return!1;if(n.firstAuthor)if(n.firstAuthor===LAB_MEMBER_FACET_VALUE){if(!e.firstAuthor||!e.labMembers.includes(e.firstAuthor))return!1}else if(n.firstAuthor===OTHER_FACET_VALUE){if(!e.firstAuthor||e.labMembers.includes(e.firstAuthor))return!1}else if(e.firstAuthor!==n.firstAuthor)return!1;if(n.corresponding)if(n.corresponding===LAB_MEMBER_FACET_VALUE){if(!e.corresponding.some(t=>e.labMembers.includes(t)))return!1}else if(n.corresponding===OTHER_FACET_VALUE){if(!e.corresponding.length||e.corresponding.some(t=>e.labMembers.includes(t)))return!1}else if(!e.corresponding.includes(n.corresponding))return!1;return!0},k=(e,t)=>e.year!==t.year?t.year-e.year:e.month!==t.month?t.month-e.month:e.index-t.index,F=e=>{const t=[...e];return"citations"===g?(t.sort((e,t)=>t.citationCount!==e.citationCount?t.citationCount-e.citationCount:k(e,t)),t):"altmetric"===g?(t.sort((e,t)=>t.altmetricScore!==e.altmetricScore?t.altmetricScore-e.altmetricScore:k(e,t)),t):"lab"===g?(t.sort((e,t)=>t.contributionScore!==e.contributionScore?t.contributionScore-e.contributionScore:k(e,t)),t):(t.sort(k),t)},I=e=>{if(p.innerHTML="",!e.length){const e=createElement("p","pub-empty-state");return e.textContent=i18n.noResults,void p.appendChild(e)}if("newest"===g){const t=new Map;return e.forEach(e=>{t.has(e.year)||t.set(e.year,[]),t.get(e.year).push(e)}),void[...t.keys()].sort((e,t)=>t-e).forEach(e=>{const n=createElement("h2","bibliography");n.textContent=e.toString();const r=createElement("ol","bibliography");t.get(e).forEach(e=>r.appendChild(e.listItem)),p.append(n,r)})}const t=createElement("h2","bibliography pub-sorted-heading");t.textContent=`${i18n.sortedResults} (${"citations"===g?"Citations":"altmetric"===g?"Altmetric":"Lab contribution"})`;const n=createElement("ol","bibliography");e.forEach(e=>n.appendChild(e.listItem)),p.append(t,n)},T=e=>{a&&(a.textContent=`${i18n.showing}: ${e} / ${s.length}`)},M=e=>{if("undefined"!=typeof CSS&&"highlights"in CSS&&CSS.highlights)try{highlightSearchTerm({search:e,selector:"#publications-results li"})}catch{}},R=()=>{const e=getComputedStyle(document.documentElement);return{themeColor:e.getPropertyValue("--global-theme-color").trim()||"#2f7f75",textColor:e.getPropertyValue("--global-text-color").trim()||"#334155",dividerColor:e.getPropertyValue("--global-divider-color").trim()||"#cbd5e1",secondaryColor:e.getPropertyValue("--global-text-color-light").trim()||"#94a3b8"}},B=()=>!!window.Chart||(_+=1,_>20||setTimeout(()=>O(H),300),!1),P=(e,t,n,r,o,a={})=>{const i=document.getElementById(t);if(!i)return;const l=R();if(w[e])return w[e].data.labels=r,w[e].data.datasets=o,void w[e].update();w[e]=new window.Chart(i,{type:n,data:{labels:r,datasets:o},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,labels:{color:l.textColor}}},scales:{x:{ticks:{color:l.textColor},grid:{color:l.dividerColor}},y:{ticks:{color:l.textColor,precision:0},grid:{color:l.dividerColor}}},...a}})},O=e=>{if(!B())return;const t=new Map(m.map(e=>[e,{lead:0,other:0}]));e.forEach(e=>{const n=e.year.toString();if(!t.has(n))return;const r=t.get(n);e.leadRole?r.lead+=1:r.other+=1});const n=m,r=R(),o=n.map(e=>t.get(e).lead),a=n.map(e=>t.get(e).other),i=(e,t,o,a)=>{const i=Math.max(0,...e);return Array.from({length:i},(i,l)=>({label:t,data:n.map((t,n)=>e[n]>l?1:0),backgroundColor:o,borderColor:r.dividerColor,borderWidth:1,borderSkipped:!1,stack:"publication-counts",unitRole:a,unitLevel:l}))},l=[...i(o,i18n.leadRoleLabel,r.themeColor,"lead"),...i(a,i18n.otherRoleLabel,r.secondaryColor,"other")];P("byYear","pub-chart-year","bar",n,l,{plugins:{legend:{display:!0,labels:{color:r.textColor,filter:(e,t)=>{const n=t.datasets?.[e.datasetIndex];return 0===n?.unitLevel}}},tooltip:{callbacks:{label:e=>{const t=e.dataset;if(!t||0!==t.unitLevel)return null;const n=e.dataIndex;return"lead"===t.unitRole?`${i18n.leadRoleLabel}: ${o[n]}`:`${i18n.otherRoleLabel}: ${a[n]}`}}}},scales:{x:{stacked:!0,ticks:{color:r.textColor},grid:{color:r.dividerColor}},y:{stacked:!0,beginAtZero:!0,ticks:{color:r.textColor,precision:0,stepSize:1},title:{display:!0,text:i18n.paperCountAxisLabel,color:r.textColor},grid:{color:r.dividerColor}}}})},$=(e,t)=>new Promise((n,r)=>{const o=document.getElementById(e);if(o)return void n(o);const a=document.createElement("script");a.id=e,a.src=t,a.async=!0,a.onload=()=>n(a),a.onerror=()=>r(new Error(`Failed to load ${t}`)),document.head.appendChild(a)}),N=()=>{"function"==typeof window._altmetric_embed_init&&window._altmetric_embed_init(),window.__dimensions_embed&&"function"==typeof window.__dimensions_embed.addBadges&&window.__dimensions_embed.addBadges()},J=()=>{s.forEach(e=>{const t=e.listItem.querySelector(".altmetric-embed");if(!t)return;const n=t.textContent||"",r=parseNumber(n.replace(/[^\d.]/g,""));r>e.altmetricScore&&(e.altmetricScore=r)})},U=()=>h||(v("loading"),h=Promise.all([$("pub-altmetric-script","https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"),$("pub-dimensions-script","https://badge.dimensions.ai/badge.js")]).then(()=>{N(),J(),v("loaded"),trackAnalyticsEvent("publications_badges_loaded",{publication_count:s.length}),q()}).catch(()=>{v("error"),trackAnalyticsEvent("publications_badges_load_error",{publication_count:s.length})}),h),z=()=>{if(!("IntersectionObserver"in window))return;const e=s.find(e=>e.listItem.querySelector(".badges"))?.listItem;if(!e)return;const t=new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&(U(),t.disconnect())},{rootMargin:"120px 0px"});t.observe(e)},V=async()=>{if(y)return y;const e=s.filter(e=>e.doi&&e.citationCount<=0);if(!e.length)return Promise.resolve();const t=4;let n=0;return v(b,i18n.citationHydrating),y=Promise.all(Array.from({length:t}).map(async()=>{for(;n<e.length;){const t=n;n+=1;const r=e[t];try{const e=await fetch(`https://api.crossref.org/works/${encodeURIComponent(r.doi)}`);if(!e.ok)continue;const t=await e.json(),n=Number.parseInt(t?.message?.["is-referenced-by-count"],10);Number.isFinite(n)&&(r.citationCount=n)}catch{}}})).finally(()=>{v(b,i18n.citationHydrated)}),y};let H=[...s];const q=()=>{const e=normalize(t.value),n=S(),r=s.filter(t=>x(t,e,n)),o=F(r);I(o),T(o.length),M(e),O(o),"altmetric"===g&&a&&o.every(e=>e.altmetricScore<=0)&&(a.textContent=`${a.textContent} | ${i18n.altmetricHint}`),"loaded"===b&&N(),H=o},D=()=>{const e=t.value.trim(),n=e?`#${encodeURIComponent(e)}`:"";history.replaceState(null,"",`${window.location.pathname}${window.location.search}${n}`)},j=()=>{clearTimeout(E),E=setTimeout(()=>{D(),q();const e=normalize(t.value);e!==C&&(C=e,trackAnalyticsEvent("publications_search",{query_length:e.length}))},250)},Y=()=>{t.value="",defaultFacetConfig.forEach(e=>{const t=document.getElementById(e.id);t&&(t.value="")}),n&&(n.value="newest",g="newest"),D(),q(),trackAnalyticsEvent("publications_filters_reset")},W=()=>{const e=decodeURIComponent(window.location.hash.replace(/^#/,""));e&&(t.value=e)};t.addEventListener("input",j),window.addEventListener("hashchange",()=>{W(),q()}),defaultFacetConfig.forEach(e=>{const t=document.getElementById(e.id);t&&t.addEventListener("change",()=>{q(),trackAnalyticsEvent("publications_filter_change",{filter_name:e.key,filter_value:t.value||"all"})})}),n&&n.addEventListener("change",()=>{g=n.value,q(),"citations"===g?(f||(f=!0,V()),y&&y.finally(()=>{"citations"===g&&q()})):"altmetric"===g&&"loaded"!==b&&U().finally(()=>{"altmetric"===g&&q()}),trackAnalyticsEvent("publications_sort_change",{sort:g})}),r&&r.addEventListener("click",Y),o&&o.addEventListener("click",()=>{trackAnalyticsEvent("publications_badges_load_click"),U()}),v("idle"),L(),W(),q(),z()});