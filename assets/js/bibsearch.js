import{highlightSearchTerm}from"./highlight-search-term.js";const normalize=e=>(e??"").toString().trim().toLowerCase(),parseNumber=e=>{const t=Number.parseFloat(e);return Number.isFinite(t)?t:0},uniqueSorted=e=>[...new Set(e.filter(Boolean))].sort((e,t)=>e.localeCompare(t)),splitDelimited=e=>normalize(e).split("||").map(e=>e.trim()).filter(Boolean),nameForDisplay=e=>{const t=normalize(e);if(!t)return"";const[r,o]=t.split(",").map(e=>e.trim());return o&&r?`${o} ${r}`:t.replace(/\b\w/g,e=>e.toUpperCase())},typeForDisplay=e=>normalize(e).replace(/\s+/g," ").replace(/\b\w/g,e=>e.toUpperCase()),createElement=(e,t="")=>{const r=document.createElement(e);return t&&(r.className=t),r},isJapanesePage=document.documentElement.lang.toLowerCase().startsWith("ja"),LAB_MEMBER_FACET_VALUE="__lab_member__",OTHER_FACET_VALUE="__other__",i18n={all:isJapanesePage?"\u3059\u3079\u3066":"All",showing:isJapanesePage?"\u8868\u793a\u4e2d":"Showing",sortedResults:isJapanesePage?"\u4e26\u3073\u66ff\u3048\u7d50\u679c":"Sorted results",newest:isJapanesePage?"\u65b0\u7740\u9806":"Newest",noResults:isJapanesePage?"\u8a72\u5f53\u3059\u308b\u8ad6\u6587\u304c\u3042\u308a\u307e\u305b\u3093\u3002":"No matching publications.",badgeIdle:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u306f\u672a\u8aad\u8fbc\u3067\u3059\u3002":"External badges are not loaded yet.",badgeLoading:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u3092\u8aad\u307f\u8fbc\u307f\u4e2d...":"Loading external badges...",badgeLoaded:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u3092\u8aad\u307f\u8fbc\u307f\u307e\u3057\u305f\u3002":"External badges loaded.",badgeError:isJapanesePage?"\u5916\u90e8\u30d0\u30c3\u30b8\u306e\u8aad\u307f\u8fbc\u307f\u306b\u5931\u6557\u3057\u307e\u3057\u305f\u3002":"Failed to load external badges.",citationHydrating:isJapanesePage?"\u88ab\u5f15\u7528\u6570\u3092\u66f4\u65b0\u4e2d...":"Refreshing citation counts...",citationHydrated:isJapanesePage?"\u88ab\u5f15\u7528\u6570\u3092\u66f4\u65b0\u3057\u307e\u3057\u305f\u3002":"Citation counts refreshed.",leadRoleLabel:isJapanesePage?"lab member\u304cfirst/co-first/corresponding":"Lab member as first/co-first/corresponding",otherRoleLabel:isJapanesePage?"\u305d\u308c\u4ee5\u5916":"Other",labMemberFacetOption:"lab member",otherFacetOption:"other",altmetricHint:isJapanesePage?"Altmetric\u9806\u306f`altmetric_score`\u304c\u3042\u308b\u8ad6\u6587\u3092\u512a\u5148\u3057\u3066\u4e26\u3073\u66ff\u3048\u307e\u3059\u3002":"Altmetric sort prioritizes publications with `altmetric_score` metadata."},defaultFacetConfig=[{id:"facet-year",key:"year",labeler:e=>e.toString()},{id:"facet-article-type",key:"articleType",labeler:typeForDisplay},{id:"facet-first-author",key:"firstAuthor",labeler:nameForDisplay,fixedOptions:[{value:LAB_MEMBER_FACET_VALUE,label:i18n.labMemberFacetOption},{value:OTHER_FACET_VALUE,label:i18n.otherFacetOption}]},{id:"facet-corresponding",key:"corresponding",labeler:nameForDisplay,isList:!0,fixedOptions:[{value:LAB_MEMBER_FACET_VALUE,label:i18n.labMemberFacetOption},{value:OTHER_FACET_VALUE,label:i18n.otherFacetOption}]}];document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".publications"),t=document.getElementById("bibsearch");if(!e||!t)return;const r=document.getElementById("pub-sort"),o=document.getElementById("pub-reset-filters"),n=document.getElementById("pub-load-badges"),a=document.getElementById("pub-active-count"),i=document.getElementById("pub-badge-status"),l=Array.from(e.querySelectorAll("ol.bibliography > li"));if(!l.length)return;const s=l.map((e,t)=>{const r=e.querySelector(".publication-entry");if(!r)return null;const o=Number.parseInt(r.dataset.year??"0",10)||0,n=Number.parseInt(r.dataset.month??"0",10)||0,a=normalize(r.dataset.firstAuthor),i=splitDelimited(r.dataset.corresponding),l=splitDelimited(r.dataset.coFirst),s=splitDelimited(r.dataset.labMembers),c=normalize(r.dataset.articleType),d=parseNumber(r.dataset.citationCount),m=parseNumber(r.dataset.altmetricScore),u=normalize(r.dataset.doi),p=new Set(s);let g=s.length;a&&p.has(a)&&(g+=2),g+=l.filter(e=>p.has(e)).length,g+=i.filter(e=>p.has(e)).length;const b=a&&p.has(a)||l.some(e=>p.has(e))||i.some(e=>p.has(e));return{index:t,listItem:e,publicationEntry:r,title:normalize(e.querySelector(".publication-title .title")?.textContent),searchText:normalize(e.textContent),year:o,month:n,articleType:c,firstAuthor:a,corresponding:i,coFirst:l,labMembers:s,citationCount:d,altmetricScore:m,contributionScore:g,leadRole:b,doi:u}}).filter(Boolean),c=s.map(e=>e.year).filter(e=>Number.isInteger(e)&&e>0),d=c.length?Math.min(...c):(new Date).getFullYear(),m=c.length?Math.max(...c):d,u=Array.from({length:m-d+1},(e,t)=>(d+t).toString()),p=createElement("div","publications-results");p.id="publications-results",e.querySelectorAll("h2.bibliography, ol.bibliography").forEach(e=>e.remove()),e.appendChild(p);let g=r?.value||"newest",b="idle",h=null,f=!1,y=null,E=null,C=0,w={byYear:null};const _=(e,t="")=>{b=e,i&&(i.textContent=t||("loading"===e?i18n.badgeLoading:"loaded"===e?i18n.badgeLoaded:"error"===e?i18n.badgeError:i18n.badgeIdle))},A=(e,t,r,o=[])=>{const n=document.getElementById(e);if(!n)return;const a=n.value;n.innerHTML="";const i=document.createElement("option");i.value="",i.textContent=i18n.all,n.appendChild(i),o.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,n.appendChild(t)}),t.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=r(e),n.appendChild(t)}),a&&Array.from(n.options).some(e=>e.value===a)&&(n.value=a)},v=()=>{defaultFacetConfig.forEach(e=>{if(e.fixedOptions)return void A(e.id,[],e.labeler,e.fixedOptions);const t=e.isList?uniqueSorted(s.flatMap(t=>t[e.key])):uniqueSorted(s.map(t=>"year"===e.key?t.year.toString():t[e.key])),r="year"===e.key?t.sort((e,t)=>Number.parseInt(t,10)-Number.parseInt(e,10)):t;A(e.id,r,e.labeler,[])})},S=()=>{const e={};return defaultFacetConfig.forEach(t=>{const r=document.getElementById(t.id);e[t.key]=normalize(r?.value)}),e},x=(e,t,r)=>{if(t&&!e.searchText.includes(t))return!1;if(r.year&&e.year.toString()!==r.year)return!1;if(r.articleType&&e.articleType!==r.articleType)return!1;if(r.firstAuthor)if(r.firstAuthor===LAB_MEMBER_FACET_VALUE){if(!e.firstAuthor||!e.labMembers.includes(e.firstAuthor))return!1}else if(r.firstAuthor===OTHER_FACET_VALUE){if(!e.firstAuthor||e.labMembers.includes(e.firstAuthor))return!1}else if(e.firstAuthor!==r.firstAuthor)return!1;if(r.corresponding)if(r.corresponding===LAB_MEMBER_FACET_VALUE){if(!e.corresponding.some(t=>e.labMembers.includes(t)))return!1}else if(r.corresponding===OTHER_FACET_VALUE){if(!e.corresponding.length||e.corresponding.some(t=>e.labMembers.includes(t)))return!1}else if(!e.corresponding.includes(r.corresponding))return!1;return!0},L=(e,t)=>e.year!==t.year?t.year-e.year:e.month!==t.month?t.month-e.month:e.index-t.index,F=e=>{const t=[...e];return"citations"===g?(t.sort((e,t)=>t.citationCount!==e.citationCount?t.citationCount-e.citationCount:L(e,t)),t):"altmetric"===g?(t.sort((e,t)=>t.altmetricScore!==e.altmetricScore?t.altmetricScore-e.altmetricScore:L(e,t)),t):"lab"===g?(t.sort((e,t)=>t.contributionScore!==e.contributionScore?t.contributionScore-e.contributionScore:L(e,t)),t):(t.sort(L),t)},I=e=>{if(p.innerHTML="",!e.length){const e=createElement("p","pub-empty-state");return e.textContent=i18n.noResults,void p.appendChild(e)}if("newest"===g){const t=new Map;return e.forEach(e=>{t.has(e.year)||t.set(e.year,[]),t.get(e.year).push(e)}),void[...t.keys()].sort((e,t)=>t-e).forEach(e=>{const r=createElement("h2","bibliography");r.textContent=e.toString();const o=createElement("ol","bibliography");t.get(e).forEach(e=>o.appendChild(e.listItem)),p.append(r,o)})}const t=createElement("h2","bibliography pub-sorted-heading");t.textContent=`${i18n.sortedResults} (${"citations"===g?"Citations":"altmetric"===g?"Altmetric":"Lab contribution"})`;const r=createElement("ol","bibliography");e.forEach(e=>r.appendChild(e.listItem)),p.append(t,r)},T=e=>{a&&(a.textContent=`${i18n.showing}: ${e} / ${s.length}`)},M=e=>{CSS.highlights&&highlightSearchTerm({search:e,selector:"#publications-results li"})},B=()=>{const e=getComputedStyle(document.documentElement);return{themeColor:e.getPropertyValue("--global-theme-color").trim()||"#2f7f75",textColor:e.getPropertyValue("--global-text-color").trim()||"#334155",dividerColor:e.getPropertyValue("--global-divider-color").trim()||"#cbd5e1",secondaryColor:e.getPropertyValue("--global-text-color-light").trim()||"#94a3b8"}},R=()=>!!window.Chart||(C+=1,C>20||setTimeout(()=>k(H),300),!1),P=(e,t,r,o,n,a={})=>{const i=document.getElementById(t);if(!i)return;const l=B();if(w[e])return w[e].data.labels=o,w[e].data.datasets=n,void w[e].update();w[e]=new window.Chart(i,{type:r,data:{labels:o,datasets:n},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,labels:{color:l.textColor}}},scales:{x:{ticks:{color:l.textColor},grid:{color:l.dividerColor}},y:{ticks:{color:l.textColor,precision:0},grid:{color:l.dividerColor}}},...a}})},k=e=>{if(!R())return;const t=new Map(u.map(e=>[e,{lead:0,other:0}]));e.forEach(e=>{const r=e.year.toString();if(!t.has(r))return;const o=t.get(r);e.leadRole?o.lead+=1:o.other+=1});const r=u,o=B(),n=r.map(e=>t.get(e).lead),a=r.map(e=>t.get(e).other),i=[{label:i18n.leadRoleLabel,data:n,backgroundColor:o.themeColor,borderColor:o.themeColor,borderWidth:1},{label:i18n.otherRoleLabel,data:a,backgroundColor:o.secondaryColor,borderColor:o.secondaryColor,borderWidth:1}];P("byYear","pub-chart-year","bar",r,i,{scales:{x:{stacked:!0,ticks:{color:o.textColor},grid:{color:o.dividerColor}},y:{stacked:!0,ticks:{color:o.textColor,precision:0},grid:{color:o.dividerColor}}}})},O=(e,t)=>new Promise((r,o)=>{const n=document.getElementById(e);if(n)return void r(n);const a=document.createElement("script");a.id=e,a.src=t,a.async=!0,a.onload=()=>r(a),a.onerror=()=>o(new Error(`Failed to load ${t}`)),document.head.appendChild(a)}),N=()=>{"function"==typeof window._altmetric_embed_init&&window._altmetric_embed_init(),window.__dimensions_embed&&"function"==typeof window.__dimensions_embed.addBadges&&window.__dimensions_embed.addBadges()},J=()=>{s.forEach(e=>{const t=e.listItem.querySelector(".altmetric-embed");if(!t)return;const r=t.textContent||"",o=parseNumber(r.replace(/[^\d.]/g,""));o>e.altmetricScore&&(e.altmetricScore=o)})},U=()=>h||(_("loading"),h=Promise.all([O("pub-altmetric-script","https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"),O("pub-dimensions-script","https://badge.dimensions.ai/badge.js")]).then(()=>{N(),J(),_("loaded"),z()}).catch(()=>{_("error")}),h),$=()=>{if(!("IntersectionObserver"in window))return;const e=s.find(e=>e.listItem.querySelector(".badges"))?.listItem;if(!e)return;const t=new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&(U(),t.disconnect())},{rootMargin:"120px 0px"});t.observe(e)},V=async()=>{if(y)return y;const e=s.filter(e=>e.doi&&e.citationCount<=0);if(!e.length)return Promise.resolve();const t=4;let r=0;return _(b,i18n.citationHydrating),y=Promise.all(Array.from({length:t}).map(async()=>{for(;r<e.length;){const t=r;r+=1;const o=e[t];try{const e=await fetch(`https://api.crossref.org/works/${encodeURIComponent(o.doi)}`);if(!e.ok)continue;const t=await e.json(),r=Number.parseInt(t?.message?.["is-referenced-by-count"],10);Number.isFinite(r)&&(o.citationCount=r)}catch{}}})).finally(()=>{_(b,i18n.citationHydrated)}),y};let H=[...s];const z=()=>{const e=normalize(t.value),r=S(),o=s.filter(t=>x(t,e,r)),n=F(o);I(n),T(n.length),M(e),k(n),"altmetric"===g&&a&&n.every(e=>e.altmetricScore<=0)&&(a.textContent=`${a.textContent} | ${i18n.altmetricHint}`),"loaded"===b&&N(),H=n},D=()=>{const e=t.value.trim(),r=e?`#${encodeURIComponent(e)}`:"";history.replaceState(null,"",`${window.location.pathname}${window.location.search}${r}`)},q=()=>{clearTimeout(E),E=setTimeout(()=>{D(),z()},250)},j=()=>{t.value="",defaultFacetConfig.forEach(e=>{const t=document.getElementById(e.id);t&&(t.value="")}),r&&(r.value="newest",g="newest"),D(),z()},W=()=>{const e=decodeURIComponent(window.location.hash.replace(/^#/,""));e&&(t.value=e)};t.addEventListener("input",q),window.addEventListener("hashchange",()=>{W(),z()}),defaultFacetConfig.forEach(e=>{const t=document.getElementById(e.id);t&&t.addEventListener("change",z)}),r&&r.addEventListener("change",async()=>{g=r.value,"citations"!==g||f||(f=!0,await V()),z()}),o&&o.addEventListener("click",j),n&&n.addEventListener("click",()=>{U()}),_("idle"),v(),W(),z(),$()});